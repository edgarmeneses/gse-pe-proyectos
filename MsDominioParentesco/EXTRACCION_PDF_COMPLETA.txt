================================================================================
EXTRACCIÓN COMPLETA DEL PDF: Microservicio MsDominioParentesco V1.0
================================================================================
Fecha de extracción: 01/12/2025
Documento Versión: 1.0
Fecha generación documento: 01/12/2025
Última actualización: 24/11/2025
Responsable: Arquitecto de Software

================================================================================
1. NOMBRE COMPLETO DEL MICROSERVICIO
================================================================================
MsDominioParentesco (Microservicio Dominio Parentesco)

================================================================================
2. CONTEXTO DE NEGOCIO
================================================================================

2.1 CONTEXTO GENERAL:
El Registro Nacional de Identificación y Estado Civil (RENIEC) es el organismo 
técnico autónomo encargado de la identificación de los peruanos, otorgar el 
Documento Nacional de Identidad (DNI) y registrar los hechos vitales. En el 
marco de la modernización y transformación digital del Estado peruano, RENIEC 
ha desarrollado el DNI Electrónico (DNIe), un documento de identidad que 
incorpora tecnología de chip y biometría, permitiendo la autenticación 
electrónica de ciudadanos y facilitando servicios digitales seguros.

2.2 PROPÓSITO DEL MICROSERVICIO:
El Microservicio Dominio Parentesco es el componente de lógica de negocio de 
la plataforma SIIRC especializado en el análisis, validación y certificación 
de vínculos familiares entre ciudadanos. Su propósito principal es gestionar 
y centralizar toda la inteligencia de negocio relacionada con el análisis de 
parentesco, actuando como el motor que verifica la coherencia de las relaciones 
familiares contra las reglas del registro civil peruano.

Este microservicio orquesta el proceso completo de análisis de vínculos, desde 
la recepción de una solicitud hasta la generación automática de la población 
de posibles vínculos, coordinando la consulta de datos del APD y actas 
registrales para establecer cadenas de parentesco hasta el cuarto grado de 
consanguinidad y segundo de afinidad.

2.3 SOLUCIÓN GENERAL:
Este documento describe el catálogo de microservicios identificados para la 
solución de Personalización del DNIe de RENIEC. El objetivo es establecer una 
arquitectura técnica moderna, escalable y mantenible que reemplace o complemente 
los sistemas monolíticos actuales mediante una transición ordenada hacia una 
arquitectura orientada a microservicios.

2.4 JUSTIFICACIÓN DE ARQUITECTURA:
- Escalabilidad Independiente: Componentes con cargas diferenciadas pueden 
  escalar de forma independiente según demanda real, optimizando recursos de 
  infraestructura.
- Resiliencia y Tolerancia a Fallos: El fallo de un microservicio no compromete 
  servicios críticos. Los patrones Circuit Breaker y Retry garantizan continuidad 
  operativa.
- Agilidad en el Desarrollo: Equipos autónomos pueden desarrollar, probar y 
  desplegar servicios de manera independiente, reduciendo tiempos de entrega.
- Mantenibilidad y Evolución Tecnológica: Cada servicio puede evolucionar 
  tecnológicamente sin afectar al ecosistema completo.
- Trazabilidad y Observabilidad: Arquitectura distribuida permite implementar 
  logging centralizado, distributed tracing y métricas granulares.

2.5 ARQUITECTURA DE REFERENCIA:
La solución se estructura en tres capas principales:
- Capa de Exposición (API Management Layer): API Manager como punto único de 
  entrada con gestión centralizada de seguridad, throttling y versionado.
- Capa de Representación (Microservices Layer): Microservicios de negocio con 
  lógica específica de dominio y responsabilidad única.
- Capa de Integración (Integration Layer): Event Streaming para comunicación 
  asíncrona y conectores a sistemas legados.

================================================================================
3. VERSIÓN DEL API
================================================================================
v1 (api/v1)

================================================================================
4. ENDPOINTS COMPLETOS
================================================================================

4.1 ENDPOINT: EJECUTAR ANÁLISIS DE PARENTESCO
--------------------------------------------------------------------------------

4.1.1 INFORMACIÓN GENERAL:
- Nombre: Ejecutar Análisis de Parentesco
- Path: /api/v1/parentesco/MsDominioParentesco/analisis/ejecutar
- API Gateway: Interno
- Método HTTP: POST
- Protocolo: REST/HTTP

4.1.2 DESCRIPCIÓN:
Endpoint que inicia y ejecuta el proceso de análisis de vínculos de parentesco 
para una persona natural, generando automáticamente la población de posibles 
vínculos según el tipo de parentesco y nivel de complejidad solicitado. El 
análisis se basa en la consulta del APD del ciudadano y la correlación con 
actas registrales (nacimiento, matrimonio, defunción) para establecer la cadena 
de parentesco completa.

4.1.3 HEADERS:
- Authorization: String (Bearer token JWT para autenticación del usuario)
- Content-Type: String ("application/json")
- X-Correlation-ID: UUID (Identificador único de correlación para trazabilidad 
  end-to-end)
- X-Office-Code: String (Código de oficina RENIEC formato: ORG-LIMA-CENTRO)
- X-User-Role: String (Rol del usuario: TECNICO_VINCULO, COORDINADOR_VINCULO)
- X-Idempotency-Key: UUID (Clave de idempotencia para evitar duplicados)

4.1.4 PATH PARAMETERS:
No aplica (no se especifican en el documento)

4.1.5 QUERY PARAMETERS:
No aplica (no se especifican en el documento)

4.1.6 REQUEST BODY (JSON):
{
  "idSolicitud": "string",
  "idCiudadanoConsultado": "string",
  "datosCiudadano": {
    "nombres": "string",
    "apellidoPaterno": "string",
    "apellidoMaterno": "string",
    "fechaNacimiento": "YYYY-MM-DD",
    "sexo": "string",
    "estadoCivil": "string"
  },
  "tipoVinculo": "string",
  "nivelComplejidad": "integer",
  "criteriosBusqueda": {
    "rangoAniosPadres": {
      "anioInicio": "integer",
      "anioFin": "integer"
    },
    "rangoAniosHijos": {
      "anioInicio": "integer",
      "anioFin": "integer"
    },
    "variacionesNombre": ["string"],
    "incluirFallecidos": "boolean",
    "incluirActasAnuladas": "boolean"
  },
  "opcionesAnalisis": {
    "generarArbolGenealogico": "boolean",
    "validarContraAPD": "boolean",
    "incluirActasSustento": "boolean",
    "detectarInconsistencias": "boolean"
  },
  "usuarioTecnico": "string",
  "observaciones": "string"
}

4.1.7 DETALLE DE PARÁMETROS DE ENTRADA:

Dato                          | Atributo                                        | Tipo                | Obligatorio | Long. Mín | Long. Máx
------------------------------|------------------------------------------------|---------------------|-------------|-----------|----------
ID Solicitud                  | idSolicitud                                     | String              | Sí          | 5         | 50
ID Ciudadano Consultado       | idCiudadanoConsultado                           | String              | Sí          | 8         | 12
Datos del Ciudadano           | datosCiudadano                                  | Object              | Sí          | -         | -
Nombres                       | datosCiudadano.nombres                          | String              | Sí          | 2         | 100
Apellido Paterno              | datosCiudadano.apellidoPaterno                  | String              | Sí          | 2         | 50
Apellido Materno              | datosCiudadano.apellidoMaterno                  | String              | No          | 2         | 50
Fecha Nacimiento              | datosCiudadano.fechaNacimiento                  | String (Date ISO)   | Sí          | 10        | 10
Sexo                          | datosCiudadano.sexo                             | String (Enum: M, F) | Sí          | 1         | 1
Estado Civil                  | datosCiudadano.estadoCivil                      | String              | No          | 3         | 20
Tipo de Vínculo               | tipoVinculo                                     | String (Enum)       | Sí          | 5         | 50
Nivel de Complejidad          | nivelComplejidad                                | Integer (1-4)       | Sí          | 1         | 1
Criterios de Búsqueda         | criteriosBusqueda                               | Object              | No          | -         | -
Rango Años Padres             | criteriosBusqueda.rangoAniosPadres              | Object              | No          | -         | -
Año Inicio Padres             | criteriosBusqueda.rangoAniosPadres.anioInicio   | Integer             | No          | 4         | 4
Año Fin Padres                | criteriosBusqueda.rangoAniosPadres.anioFin      | Integer             | No          | 4         | 4
Rango Años Hijos              | criteriosBusqueda.rangoAniosHijos               | Object              | No          | -         | -
Año Inicio Hijos              | criteriosBusqueda.rangoAniosHijos.anioInicio    | Integer             | No          | 4         | 4
Año Fin Hijos                 | criteriosBusqueda.rangoAniosHijos.anioFin       | Integer             | No          | 4         | 4
Variaciones de Nombre         | criteriosBusqueda.variacionesNombre             | Array[String]       | No          | 0         | 10
Incluir Fallecidos            | criteriosBusqueda.incluirFallecidos             | Boolean             | No          | -         | -
Incluir Actas Anuladas        | criteriosBusqueda.incluirActasAnuladas          | Boolean             | No          | -         | -
Opciones de Análisis          | opcionesAnalisis                                | Object              | No          | -         | -
Generar Árbol Genealógico     | opcionesAnalisis.generarArbolGenealogico        | Boolean             | No          | -         | -
Validar Contra APD            | opcionesAnalisis.validarContraAPD               | Boolean             | No          | -         | -
Incluir Actas Sustento        | opcionesAnalisis.incluirActasSustento           | Boolean             | No          | -         | -
Detectar Inconsistencias      | opcionesAnalisis.detectarInconsistencias        | Boolean             | No          | -         | -
Usuario Técnico               | usuarioTecnico                                  | String              | Sí          | 3         | 50
Observaciones                 | observaciones                                   | String              | No          | 0         | 500

4.1.8 RESPONSE BODY (JSON) - ÉXITO:
{
  "success": "boolean",
  "data": {
    "idAnalisis": "string",
    "idSolicitud": "string",
    "idCiudadanoConsultado": "string",
    "tipoVinculo": "string",
    "nivelComplejidad": "integer",
    "estado": "string",
    "ciudadanoAnalizado": {
      "idCiudadano": "string",
      "nombreCompleto": "string",
      "fechaNacimiento": "YYYY-MM-DD",
      "estadoCivil": "string",
      "datosAPD": {
        "version": "string",
        "ultimaActualizacion": "YYYY-MM-DDThh:mm:ss±hh:mm",
        "estadoAPD": "string"
      }
    },
    "poblacionVinculosPosibles": {
      "totalEncontrados": "integer",
      "vinculosConsanguineos": [
        {
          "idVinculoPosible": "string",
          "idCiudadanoRelacionado": "string",
          "nombreCompleto": "string",
          "tipoParentesco": "string",
          "descripcionParentesco": "string",
          "gradoConsanguinidad": "integer",
          "lineaParentesco": "string",
          "actaSustento": {
            "tipoActa": "string",
            "numeroActa": "string",
            "fechaRegistro": "YYYY-MM-DD",
            "oficinaRegistral": "string"
          },
          "nivelConfianza": "number",
          "estadoConfirmacion": "string",
          "requiereValidacionManual": "boolean",
          "observaciones": "string"
        }
      ],
      "vinculosAfinidad": [
        {
          "idVinculoPosible": "string",
          "idCiudadanoRelacionado": "string",
          "nombreCompleto": "string",
          "tipoParentesco": "string",
          "descripcionParentesco": "string",
          "gradoAfinidad": "integer",
          "conyugeIntermedio": {
            "idCiudadano": "string",
            "nombreCompleto": "string"
          },
          "actaSustento": {
            "tipoActa": "string",
            "numeroActa": "string",
            "fechaRegistro": "YYYY-MM-DD",
            "oficinaRegistral": "string"
          },
          "nivelConfianza": "number",
          "estadoConfirmacion": "string",
          "requiereValidacionManual": "boolean",
          "observaciones": "string"
        }
      ]
    },
    "resumenAnalisis": {
      "vinculosGrado1": "integer",
      "vinculosGrado2": "integer",
      "vinculosGrado3": "integer",
      "vinculosGrado4": "integer",
      "vinculosAfinidad": "integer",
      "actasConsultadas": "integer",
      "actasNoDigitalizadas": "integer",
      "inconsistenciasDetectadas": "integer"
    },
    "inconsistencias": [
      {
        "tipo": "string",
        "descripcion": "string",
        "ciudadanosInvolucrados": ["string"],
        "severidad": "string",
        "accionRecomendada": "string"
      }
    ],
    "actasPendientesDigitalizacion": [
      {
        "tipoActa": "string",
        "referenciaActa": "string",
        "oficinaRegistral": "string",
        "observacion": "string"
      }
    ],
    "fechaAnalisis": "YYYY-MM-DDThh:mm:ss±hh:mm",
    "tiempoProcesamientoMs": "integer",
    "usuarioTecnico": "string"
  },
  "metadata": {
    "timestamp": "YYYY-MM-DDThh:mm:ss±hh:mm",
    "correlationId": "string",
    "version": "string",
    "serviciosConsultados": {
      "msSagaAPD": "boolean",
      "msDatosActas": "boolean",
      "msDatosParentesco": "boolean"
    }
  }
}

4.1.9 DETALLE DE PARÁMETROS DE RESPUESTA:

Nombre                                           | Tipo    | Obligatorio | Descripción
-------------------------------------------------|---------|-------------|----------------------------------
success                                          | Boolean | Sí          | Operación exitosa
data                                             | Object  | Sí          | Resultado del análisis
data.idAnalisis                                  | String  | Sí          | ID único del análisis
data.idSolicitud                                 | String  | Sí          | Solicitud asociada
data.idCiudadanoConsultado                       | String  | Sí          | DNI del ciudadano analizado
data.tipoVinculo                                 | String  | Sí          | Tipo de vínculo
data.nivelComplejidad                            | Integer | Sí          | Nivel de complejidad aplicado
data.estado                                      | String  | Sí          | Estado del análisis
data.ciudadanoAnalizado                          | Object  | Sí          | Datos del ciudadano analizado
data.ciudadanoAnalizado.idCiudadano              | String  | Sí          | DNI
data.ciudadanoAnalizado.nombreCompleto           | String  | Sí          | Nombre completo
data.ciudadanoAnalizado.fechaNacimiento          | String  | Sí          | Fecha de nacimiento
data.ciudadanoAnalizado.estadoCivil              | String  | No          | Estado civil
data.ciudadanoAnalizado.datosAPD                 | Object  | No          | Datos del APD
data.poblacionVinculosPosibles                   | Object  | Sí          | Contenedor de vínculos
data.poblacionVinculosPosibles.totalEncontrados  | Integer | Sí          | Total encontrados

4.1.10 RESPONSE BODY (JSON) - ERROR:
{
  "error": {
    "tipo": "string",
    "titulo": "string",
    "estado": "integer",
    "errores": [
      {
        "detalleError": "string"
      }
    ]
  }
}

4.1.11 STATUS CODES:

Código | Respuesta                  | Descripción
-------|----------------------------|--------------------------------------------------
200    | OK                         | Ejecución realizada exitosamente
202    | Accepted                   | Procesamiento asíncrono en curso
400    | Bad Request                | Parámetros inválidos o incompletos
401    | Unauthorized               | Token inválido o ausente
403    | Forbidden                  | Sin permisos para análisis
404    | Not Found                  | Ciudadano no encontrado
408    | Request Timeout            | Timeout en servicios externos
409    | Conflict                   | Análisis activo existente
422    | Unprocessable Entity       | Complejidad incompatible
429    | Too Many Requests          | Rate limit excedido
500    | Internal Server Error      | Error interno
502    | Bad Gateway                | MsSagaAPD o MsDatosActas caído
503    | Service Unavailable        | Servicio no disponible
504    | Gateway Timeout            | Timeout en consulta externa

================================================================================
5. ENTIDADES DEL DOMINIO CON ATRIBUTOS Y TIPOS
================================================================================

5.1 ENTIDAD: SolicitudAnalisisParentesco (REQUEST)
--------------------------------------------------------------------------------
Atributo                                           | Tipo           | Obligatorio | Longitud Min/Max
---------------------------------------------------|----------------|-------------|------------------
idSolicitud                                        | String         | Sí          | 5 / 50
idCiudadanoConsultado                              | String         | Sí          | 8 / 12
datosCiudadano                                     | Object         | Sí          | - / -
datosCiudadano.nombres                             | String         | Sí          | 2 / 100
datosCiudadano.apellidoPaterno                     | String         | Sí          | 2 / 50
datosCiudadano.apellidoMaterno                     | String         | No          | 2 / 50
datosCiudadano.fechaNacimiento                     | String (ISO)   | Sí          | 10 / 10
datosCiudadano.sexo                                | String (Enum)  | Sí          | 1 / 1
datosCiudadano.estadoCivil                         | String         | No          | 3 / 20
tipoVinculo                                        | String (Enum)  | Sí          | 5 / 50
nivelComplejidad                                   | Integer (1-4)  | Sí          | 1 / 1
criteriosBusqueda                                  | Object         | No          | - / -
criteriosBusqueda.rangoAniosPadres                 | Object         | No          | - / -
criteriosBusqueda.rangoAniosPadres.anioInicio      | Integer        | No          | 4 / 4
criteriosBusqueda.rangoAniosPadres.anioFin         | Integer        | No          | 4 / 4
criteriosBusqueda.rangoAniosHijos                  | Object         | No          | - / -
criteriosBusqueda.rangoAniosHijos.anioInicio       | Integer        | No          | 4 / 4
criteriosBusqueda.rangoAniosHijos.anioFin          | Integer        | No          | 4 / 4
criteriosBusqueda.variacionesNombre                | Array[String]  | No          | 0 / 10 elementos
criteriosBusqueda.incluirFallecidos                | Boolean        | No          | - / -
criteriosBusqueda.incluirActasAnuladas             | Boolean        | No          | - / -
opcionesAnalisis                                   | Object         | No          | - / -
opcionesAnalisis.generarArbolGenealogico           | Boolean        | No          | - / -
opcionesAnalisis.validarContraAPD                  | Boolean        | No          | - / -
opcionesAnalisis.incluirActasSustento              | Boolean        | No          | - / -
opcionesAnalisis.detectarInconsistencias           | Boolean        | No          | - / -
usuarioTecnico                                     | String         | Sí          | 3 / 50
observaciones                                      | String         | No          | 0 / 500

5.2 ENTIDAD: AnalisisParentesco (RESPONSE)
--------------------------------------------------------------------------------
Atributo                                           | Tipo           | Obligatorio
---------------------------------------------------|----------------|-------------
success                                            | Boolean        | Sí
data                                               | Object         | Sí
data.idAnalisis                                    | String         | Sí
data.idSolicitud                                   | String         | Sí
data.idCiudadanoConsultado                         | String         | Sí
data.tipoVinculo                                   | String         | Sí
data.nivelComplejidad                              | Integer        | Sí
data.estado                                        | String         | Sí
data.fechaAnalisis                                 | String (ISO)   | Sí
data.tiempoProcesamientoMs                         | Integer        | Sí
data.usuarioTecnico                                | String         | Sí
metadata                                           | Object         | Sí
metadata.timestamp                                 | String (ISO)   | Sí
metadata.correlationId                             | String         | Sí
metadata.version                                   | String         | Sí
metadata.serviciosConsultados                      | Object         | Sí
metadata.serviciosConsultados.msSagaAPD            | Boolean        | tipo no especificado
metadata.serviciosConsultados.msDatosActas         | Boolean        | tipo no especificado
metadata.serviciosConsultados.msDatosParentesco    | Boolean        | tipo no especificado

5.3 ENTIDAD: CiudadanoAnalizado
--------------------------------------------------------------------------------
Atributo                                           | Tipo           | Obligatorio
---------------------------------------------------|----------------|-------------
idCiudadano                                        | String         | Sí
nombreCompleto                                     | String         | Sí
fechaNacimiento                                    | String (ISO)   | Sí
estadoCivil                                        | String         | No
datosAPD                                           | Object         | No
datosAPD.version                                   | String         | tipo no especificado
datosAPD.ultimaActualizacion                       | String (ISO)   | tipo no especificado
datosAPD.estadoAPD                                 | String         | tipo no especificado

5.4 ENTIDAD: PoblacionVinculosPosibles
--------------------------------------------------------------------------------
Atributo                                           | Tipo                        | Obligatorio
---------------------------------------------------|-----------------------------|-------------
totalEncontrados                                   | Integer                     | Sí
vinculosConsanguineos                              | Array[VinculoConsanguineo]  | tipo no especificado
vinculosAfinidad                                   | Array[VinculoAfinidad]      | tipo no especificado

5.5 ENTIDAD: VinculoConsanguineo
--------------------------------------------------------------------------------
Atributo                                           | Tipo           | Obligatorio
---------------------------------------------------|----------------|-------------
idVinculoPosible                                   | String         | tipo no especificado
idCiudadanoRelacionado                             | String         | tipo no especificado
nombreCompleto                                     | String         | tipo no especificado
tipoParentesco                                     | String         | tipo no especificado
descripcionParentesco                              | String         | tipo no especificado
gradoConsanguinidad                                | Integer        | tipo no especificado
lineaParentesco                                    | String         | tipo no especificado
actaSustento                                       | Object         | tipo no especificado
actaSustento.tipoActa                              | String         | tipo no especificado
actaSustento.numeroActa                            | String         | tipo no especificado
actaSustento.fechaRegistro                         | String (ISO)   | tipo no especificado
actaSustento.oficinaRegistral                      | String         | tipo no especificado
nivelConfianza                                     | Number         | tipo no especificado
estadoConfirmacion                                 | String         | tipo no especificado
requiereValidacionManual                           | Boolean        | tipo no especificado
observaciones                                      | String         | tipo no especificado

5.6 ENTIDAD: VinculoAfinidad
--------------------------------------------------------------------------------
Atributo                                           | Tipo           | Obligatorio
---------------------------------------------------|----------------|-------------
idVinculoPosible                                   | String         | tipo no especificado
idCiudadanoRelacionado                             | String         | tipo no especificado
nombreCompleto                                     | String         | tipo no especificado
tipoParentesco                                     | String         | tipo no especificado
descripcionParentesco                              | String         | tipo no especificado
gradoAfinidad                                      | Integer        | tipo no especificado
conyugeIntermedio                                  | Object         | tipo no especificado
conyugeIntermedio.idCiudadano                      | String         | tipo no especificado
conyugeIntermedio.nombreCompleto                   | String         | tipo no especificado
actaSustento                                       | Object         | tipo no especificado
actaSustento.tipoActa                              | String         | tipo no especificado
actaSustento.numeroActa                            | String         | tipo no especificado
actaSustento.fechaRegistro                         | String (ISO)   | tipo no especificado
actaSustento.oficinaRegistral                      | String         | tipo no especificado
nivelConfianza                                     | Number         | tipo no especificado
estadoConfirmacion                                 | String         | tipo no especificado
requiereValidacionManual                           | Boolean        | tipo no especificado
observaciones                                      | String         | tipo no especificado

5.7 ENTIDAD: ResumenAnalisis
--------------------------------------------------------------------------------
Atributo                                           | Tipo           | Obligatorio
---------------------------------------------------|----------------|-------------
vinculosGrado1                                     | Integer        | tipo no especificado
vinculosGrado2                                     | Integer        | tipo no especificado
vinculosGrado3                                     | Integer        | tipo no especificado
vinculosGrado4                                     | Integer        | tipo no especificado
vinculosAfinidad                                   | Integer        | tipo no especificado
actasConsultadas                                   | Integer        | tipo no especificado
actasNoDigitalizadas                               | Integer        | tipo no especificado
inconsistenciasDetectadas                          | Integer        | tipo no especificado

5.8 ENTIDAD: Inconsistencia
--------------------------------------------------------------------------------
Atributo                                           | Tipo           | Obligatorio
---------------------------------------------------|----------------|-------------
tipo                                               | String         | tipo no especificado
descripcion                                        | String         | tipo no especificado
ciudadanosInvolucrados                             | Array[String]  | tipo no especificado
severidad                                          | String         | tipo no especificado
accionRecomendada                                  | String         | tipo no especificado

5.9 ENTIDAD: ActaPendienteDigitalizacion
--------------------------------------------------------------------------------
Atributo                                           | Tipo           | Obligatorio
---------------------------------------------------|----------------|-------------
tipoActa                                           | String         | tipo no especificado
referenciaActa                                     | String         | tipo no especificado
oficinaRegistral                                   | String         | tipo no especificado
observacion                                        | String         | tipo no especificado

5.10 ENTIDAD: ErrorResponse
--------------------------------------------------------------------------------
Atributo                                           | Tipo           | Obligatorio
---------------------------------------------------|----------------|-------------
error                                              | Object         | tipo no especificado
error.tipo                                         | String         | tipo no especificado
error.titulo                                       | String         | tipo no especificado
error.estado                                       | Integer        | tipo no especificado
error.errores                                      | Array[Object]  | tipo no especificado
error.errores[].detalleError                       | String         | tipo no especificado

================================================================================
6. REGLAS DE NEGOCIO
================================================================================

6.1 ANÁLISIS DE PARENTESCO:
- El análisis se basa en la consulta del APD (Archivo Personal de Datos) del 
  ciudadano
- Se correlaciona con actas registrales: nacimiento, matrimonio, defunción
- Establece cadenas de parentesco hasta el cuarto grado de consanguinidad
- Establece cadenas de parentesco hasta el segundo grado de afinidad
- Genera automáticamente la población de posibles vínculos

6.2 NIVEL DE COMPLEJIDAD:
- El nivel de complejidad es un valor entero entre 1 y 4
- Determina la profundidad del análisis de vínculos

6.3 TIPOS DE VÍNCULO:
- Vínculos por consanguinidad (sangre)
- Vínculos por afinidad (matrimonio)

6.4 GRADOS DE PARENTESCO:
- Grado 1: Padres, hijos
- Grado 2: Abuelos, nietos, hermanos
- Grado 3: Bisabuelos, bisnietos, tíos, sobrinos
- Grado 4: Tatarabuelos, tataranietos, primos hermanos, tíos abuelos, sobrinos 
  nietos

6.5 VALIDACIONES:
- Verificación de coherencia de relaciones familiares contra reglas del registro 
  civil peruano
- Detección de inconsistencias en datos familiares
- Validación contra APD cuando está habilitada la opción
- Identificación de actas no digitalizadas

6.6 CONFIABILIDAD:
- Cada vínculo posible tiene un nivel de confianza (number)
- Algunos vínculos requieren validación manual
- Los vínculos tienen estados de confirmación

6.7 CRITERIOS DE BÚSQUEDA OPCIONALES:
- Rangos de años para búsqueda de padres
- Rangos de años para búsqueda de hijos
- Variaciones de nombre (hasta 10 variaciones)
- Opción de incluir ciudadanos fallecidos
- Opción de incluir actas anuladas

6.8 OPCIONES DE ANÁLISIS:
- Generación de árbol genealógico
- Validación contra APD
- Inclusión de actas de sustento
- Detección de inconsistencias

6.9 SEGURIDAD Y TRAZABILIDAD:
- Autenticación mediante Bearer token JWT
- Control de roles: TECNICO_VINCULO, COORDINADOR_VINCULO
- Identificador de correlación para trazabilidad end-to-end
- Código de oficina RENIEC obligatorio
- Clave de idempotencia para evitar duplicados
- Registro de usuario técnico que ejecuta el análisis

6.10 PROCESAMIENTO:
- Puede ser procesamiento síncrono (200 OK) o asíncrono (202 Accepted)
- Se registra el tiempo de procesamiento en milisegundos
- Se valida que no exista un análisis activo para el mismo ciudadano (409 Conflict)

6.11 RATE LIMITING:
- El servicio implementa límites de tasa de peticiones
- Responde con 429 Too Many Requests cuando se excede el límite

6.12 PATRONES DE RESILIENCIA:
- Circuit Breaker para tolerancia a fallos
- Retry para reintentos automáticos
- Timeouts configurados (408 Request Timeout, 504 Gateway Timeout)

================================================================================
7. REFERENCIAS A OTROS MICROSERVICIOS
================================================================================

7.1 MICROSERVICIOS CONSULTADOS (Metadata):
El microservicio MsDominioParentesco orquesta y consulta los siguientes servicios:

- msSagaAPD: Microservicio para consulta del APD (Archivo Personal de Datos)
  Estado en metadata: Boolean

- msDatosActas: Microservicio para consulta de actas registrales (nacimiento, 
  matrimonio, defunción)
  Estado en metadata: Boolean

- msDatosParentesco: Microservicio de datos de parentesco
  Estado en metadata: Boolean

7.2 SERVICIOS EXTERNOS MENCIONADOS EN STATUS CODES:
- MsSagaAPD: Se menciona explícitamente en el error 502 Bad Gateway
- MsDatosActas: Se menciona explícitamente en el error 502 Bad Gateway

7.3 OBSERVACIONES:
- Los servicios externos pueden no estar disponibles (502 Bad Gateway)
- Los servicios externos pueden no responder en tiempo esperado (504 Gateway 
  Timeout)
- El metadata de la respuesta indica qué servicios fueron consultados en cada 
  análisis

================================================================================
8. CÓDIGOS DE RESPUESTA HTTP ESTÁNDAR (TODOS LOS MICROSERVICIOS)
================================================================================

Código | Descripción
-------|-------------------------------------------------------------------------
200    | OK - Operación completada exitosamente
201    | Created - Recurso creado exitosamente
400    | Bad Request - Parámetros inválidos o datos incompletos
401    | Unauthorized - Token JWT inválido, expirado o ausente
403    | Forbidden - Sin permisos suficientes para ejecutar la operación
404    | Not Found - Recurso no encontrado en el sistema
408    | Request Timeout - Tiempo de espera agotado al conectar
409    | Conflict - Conflicto con el estado actual del recurso
422    | Unprocessable Entity - Datos válidos pero no procesables por reglas de 
       |                        negocio
429    | Too Many Requests - Límite de rate limit excedido
500    | Internal Server Error - Error interno del servicio (información 
       |                         generalizada al exterior, detalle en logs)
502    | Bad Gateway - Servicio externo no disponible o respuesta inválida
503    | Service Unavailable - Servicio temporalmente no disponible o Circuit 
       |                       Breaker abierto
504    | Gateway Timeout - Servicio externo no respondió en tiempo esperado

================================================================================
9. INFORMACIÓN ADICIONAL
================================================================================

9.1 HEADERS ESTÁNDAR:
- Authorization: Bearer token JWT para autenticación
- Content-Type: application/json
- X-Correlation-ID: UUID para trazabilidad
- X-Office-Code: Código de oficina RENIEC (formato: ORG-LIMA-CENTRO)
- X-User-Role: Rol del usuario
- X-Idempotency-Key: UUID para evitar duplicados

9.2 FORMATOS DE FECHA:
- Fecha simple: YYYY-MM-DD
- Fecha con hora: YYYY-MM-DDThh:mm:ss±hh:mm (formato ISO 8601)

9.3 TIPOS ENUM MENCIONADOS:
- Sexo: M, F
- Otros enums mencionados pero valores no especificados en el documento:
  * tipoVinculo
  * estado (del análisis)
  * tipoParentesco
  * lineaParentesco
  * estadoConfirmacion
  * tipoActa
  * severidad (de inconsistencias)

9.4 PLATAFORMA:
- Plataforma: SIIRC (Sistema de Identificación y Registro Civil - inferido)
- Solución: Personalización del DNIe de RENIEC

================================================================================
FIN DE LA EXTRACCIÓN
================================================================================
